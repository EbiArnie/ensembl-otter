#!/usr/local/bin/perl -Tw

# Author:        gr5
# Group:         anacode
# Maintainer:    gr5

use strict;
use warnings;

use SangerPaths qw{ core bioperl123 ensembl57 otter53 };

use Bio::Otter::ServerScriptSupport;
use Bio::Vega::Utils::EnsEMBL2GFF;

my $server = Bio::Otter::ServerScriptSupport->new;

my $gff_string = '';

eval {
    my $features = $server->get_requested_features;

    my %gff_args = (
        rebase      => $server->param('rebase'),
        gff_source  => $server->param('gff_source'),
        gff_seqname => $server->param('gff_seqname'),
    );

    if (@$features) {
        $gff_string = $features->[0]->slice->gff_header(%gff_args);
        for my $f (@$features) {
            my $gff = $f->to_gff(%gff_args);
            $gff_string .= $gff."\n" if $gff;
        }
    }
    else {
        $gff_string = $server->empty_gff_header;
    }
};

if ($@) {
    $server->error_exit($@);
}
else {
    $server->send_response($gff_string, 0, 1);
}

1;

