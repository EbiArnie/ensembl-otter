#!/usr/local/bin/perl -Tw

# Author:        gr5
# Group:         anacode
# Maintainer:    gr5

use strict;
use warnings;

use SangerPaths qw{ core bioperl123 ensembl58 otter54 };

use Bio::Otter::ServerScriptSupport;
use Bio::Otter::ToXML;
use Bio::Vega::Utils::EnsEMBL2GFF;

### Why not put this in Bio::Vega::Utils::EnsEMBL2GFF?
sub Bio::EnsEMBL::Gene::propagate_slice {
    my ($gene, $slice) = @_;

    foreach my $exon (@{ $gene->get_all_Exons }) {
        $exon->slice($slice);
    }
    foreach my $transcript (@{ $gene->get_all_Transcripts }) {
        $transcript->slice($slice);
    }
    $gene->slice($slice);

    return;
}

my $server = Bio::Otter::ServerScriptSupport->new;

my $gff_string = '';

eval {

    my @fetch_mapped_feature_params = ();
    foreach my $param (qw{ cs name type start end metakey csver csver_remote }) {
        my $val = $server->param($param);
        push(@fetch_mapped_feature_params, defined($val) ? $val : '');
    }

    my %gff_genes_params;
    foreach my $param (
        qw{
        rebase
        gff_source
        gff_seqname
        url_string
        transcript_analyses
        translation_xref_dbs
        }
      )
    {
        $gff_genes_params{$param} = $server->param($param);
    }

    my @analysis_names =
      $server->param('analysis')
      ? split(/,/, $server->param('analysis'))
      : (undef);
    # $analysis_name will be 'undef' if we are fetching genes of all analyses.
    my $header = '';
    foreach my $analysis_name (@analysis_names) {

        # third parameter of $slice->get_all_Genes() helps preventing lazy-loading of transcripts
        my $genes = $server->fetch_mapped_features('gene', 'get_all_Genes', [ $analysis_name, undef, 1 ],
            @fetch_mapped_feature_params,);

        foreach my $gene (@$genes) {
            $gff_string .= $gene->to_gff(%gff_genes_params);
        }
        if ($gff_string) {
            $header ||= $genes->[0]->slice->gff_header(%gff_genes_params);
        }
    }

    if ($gff_string) {
        $gff_string = $header . $gff_string;
    } else {
        $gff_string = $server->empty_gff_header;
    }
};

if ($@) {
    $server->error_exit("Error fetching genes:\n" . $@);
}
else {
    $server->send_response($gff_string, 0, 1);
}

1;

