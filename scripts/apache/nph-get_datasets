#!/usr/local/bin/perl -Tw

# Author:        jgrg
# Group:         anacode
# Maintainer:    jgrg
# Last modified: $Date: 2007-10-04 12:03:27 $
# Id:            $Id: nph-get_datasets,v 1.6 2007-10-04 12:03:27 jgrg Exp $
# Source:        $Source: /tmp/ENSCOPY-ENSEMBL-OTTER/scripts/apache/Attic/nph-get_datasets,v $

use strict;
use SangerPaths qw{ core bioperl123 ensembl46 otter48 };

use Bio::Otter::ServerScriptSupport;

my $server = Bio::Otter::ServerScriptSupport->new;

my $xml;
eval {
    my $species_hash = $server->species_hash();
    
    # Only admin users get to see mysql connection details
    my $show_details = $server->local_user || $server->admin_user;

    $xml   .= qq{  <datasets>\n};
    foreach my $dataset (keys %$species_hash) {
        my $species_subhash = $species_hash->{$dataset};

        $xml .= qq{    <dataset name="$dataset">\n};

        ### Once everything is "headcode=1" we can put an if ($show_details) around the foreach()
        foreach my $key (keys %$species_subhash) {
            my $lckey = lc($key);
            unless ($lckey eq 'headcode') {
                # Don't send mysql user names and passwords over internet
                next unless $show_details;
            }
            $xml .= qq{      <$lckey>$species_subhash->{$key}</$lckey>\n};
        }

        $xml .= qq{    </dataset>\n};
    }
    $xml .= qq{  </datasets>\n};
};

if ($@) {
    $server->error_exit($@);
} else {
    $server->send_response($xml, 1);
}

1;

=pod

=head1 get_datasets

=head1 DESCRIPTION

Returns a list of datasets to the Client.
Will only return the list the user has access to see
if the server has been setup (see ../../conf/README.user.pod).

=cut
