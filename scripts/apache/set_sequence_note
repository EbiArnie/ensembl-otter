#!/usr/local/bin/perl -Tw

# Author:        jgrg
# Group:         anacode
# Maintainer:    jgrg

use strict;
use warnings;

use SangerPaths qw{ core bioperl123 ensembl57 otter53 };

use Bio::Otter::ServerScriptSupport;

my $server = Bio::Otter::ServerScriptSupport->new;

eval {
    my $contig_name = $server->require_argument('contig');
    my $timestamp   = $server->require_argument('timestamp');
    my $text        = $server->require_argument('text');
    my $action      = $server->require_argument('action');
    
    my $author = $server->make_Author_obj;
    $server->otter_dba->get_AuthorAdaptor->store($author);

    my $odbc = $server->otter_dba->dbc;
    
    my $seq_region_sub_select = q{(SELECT seq_region_id FROM seq_region where name = ?)};

    if ($action=~/(change|modify|old)/) {
        $server->log("Changing a sequence_note");

        my $sth = $odbc->prepare(qq{
            UPDATE sequence_note
            SET note = ?
            WHERE seq_region_id = $seq_region_sub_select
            AND author_id = ?
            AND note_time = FROM_UNIXTIME(?)
            });
        $server->log(
            "Arguments = ("
            . join(', ', map { "'$_'" } ($text, $contig_name, $author->dbID, $timestamp))
            . ")\n");
        my $changed = $sth->execute($text, $contig_name, $author->dbID, $timestamp);
        $server->log("Changed $changed sequence_notes for contig $contig_name");
        die "Failed to change sequence note" unless $changed;
    }
    elsif ($action=~/(add|push|new)/) {
        $server->log("Adding a new sequence_note");

        my $sth = $odbc->prepare(qq{
            UPDATE sequence_note
               SET is_current = 'no'
             WHERE seq_region_id = $seq_region_sub_select
        });
        my $non_curr=$sth->execute($contig_name);
        $server->log("Contig $contig_name has $non_curr non-current sequence_notes now...");

        $sth = $odbc->prepare(qq{
            INSERT INTO sequence_note (seq_region_id, author_id, note_time, is_current, note)
                 VALUES (
                         $seq_region_sub_select,
                         ?,
                         FROM_UNIXTIME(?),
                         'yes',
                         ?
                 )
        });
        my $curr = $sth->execute($contig_name, $author->dbID, $timestamp, $text);
        $server->log( "... and $curr current sequence_notes");
        die "Failed to add new note" unless $curr;
    }
    else {
        die "Unknown action '$action'";
    }
};
if ($@) {
    $server->error_exit($@);
} else {
    $server->send_response("Done\n", 1);
}

1;

