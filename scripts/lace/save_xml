#!/usr/local/bin/perl -w

### save_xml

use strict;
use Bio::Otter::Lace::Defaults;

{
    my( $dataset, $seqsetname, $dir );
    my $usage = sub{ exec('perldoc', $0) };
    Bio::Otter::Lace::Defaults::do_getopt(
        'dataset=s'     => \$dataset,
        'set|seqset=s'  => \$seqsetname,
        'h|help!'       => $usage,
        'dir=s'         => \$dir,
        ) or $usage->();
    $usage->() unless $dataset and $seqsetname;
    
    my $cl       = Bio::Otter::Lace::Defaults::make_Client();
    my $dsObj    = $cl->get_DataSet_by_name($dataset);
    my $seqSet   = $dsObj->get_SequenceSet_by_name($seqsetname);
    $dsObj->selected_SequenceSet($seqSet);
    my $csObjs   = $dsObj->fetch_all_CloneSequences_for_selected_SequenceSet();

    # this means they ALL get locked.
    $seqSet->selected_CloneSequences($csObjs);

    my $debug=0;

    my $ctg_list = $seqSet->selected_CloneSequences_as_contig_list;
    # need to lock the region first
    my $lock_xml;
    my $n=0;
    foreach my $ctg(@$ctg_list){
      $n++;
      next if $debug;
      eval{
	$lock_xml .= 
	    $cl->lock_region_for_contig_from_Dataset($ctg,
						     $dsObj
						     );
      };
      if($@){
	$cl->unlock_otter_xml($lock_xml, $dataset) if $lock_xml;
	die $@;
      }
    }
    # save the xml
    print "locked $n contigs\n";

    # read a set of xml files from a directory
    my( $xml );
    if($dir){
      opendir(DIR,$dir);
      my @files=readdir(DIR);
      closedir(DIR);
      foreach my $file (@files){
	next unless $file=~/\.xml$/;
	my $ffile="$dir/$file";
	open(IN,$ffile);
	{
	  local $/ = undef;
	  $xml = <IN>;
	}
	close(IN);
	my $lxml=length($xml);
	print "writing $ffile ($lxml)\n";
	write_xml($xml,$dataset,$cl);
      }
    }else{
      {
        local $/ = undef;
        $xml = <>;
      }
      write_xml($xml,$dataset,$cl);
    }
    
    $cl->unlock_otter_xml($lock_xml, $dataset) unless $debug;
    print "unlocked contigs\n";

    sub write_xml{
      my($xml,$dataset,$cl)=@_;
      return if $debug;
      my $success;
      eval{
	$success  = $cl->save_otter_xml($xml, $dataset);
      };
      if($@){
	warn $@;
      }
    }

}

__END__

=head1 NAME - save_xml

  save_xml -dataset <DATASET> -author <NAME> -email <ADDRESS> -seqset <SEQUENCE SET>

=head1 AUTHOR

James Gilbert B<email> jgrg@sanger.ac.uk

=cut
