#!/usr/local/bin/perl -w

use strict;
use Bio::Otter::ServerScriptSupport;
use Bio::Vega::ContigLockBroker;
use Bio::Otter::CloneLockBroker;
use Bio::Otter::Converter;
use Bio::Vega::Transform::Otter;
use Bio::Vega::Transform::XML;

my $server = Bio::Otter::ServerQuery->new('dataset',
    'cs', 'csver', 'name', 'type', 'start', 'end', 'strand', 'hostname'
);

my $cs      = $server->getarg('cs')       || 'chromosome';
my $csver   = $server->getarg('csver')    || (($cs eq 'chromosome') ? 'Otter' : undef);
my $name    = $server->requite_argument('name');
my $type    = $server->requite_argument('type');
my $start   = $server->requite_argument('start');
my $end     = $server->requite_argument('end');
my $strand  = $server->getarg('strand')   || undef;
my $cl_host = $server->getarg('hostname') || $ENV{REMOTE_ADDR};

my $odba             = $server->otter_dba();

my $cb = $server->running_headcode()
    ? Bio::Vega::ContigLockBroker->new
    : Bio::Otter::CloneLockBroker->new($odba);
$cb->client_hostname($cl_host);

$server->log("Getting slice [$name] [$start] [$end]");
my $slice      = $server->get_slice($odba, $cs, $name, $type, $start, $end, $strand, $csver);
my $author_obj = $server->make_Author_obj();

$server->log("Attempting to lock clones...");
eval {
    $cb->lock_clones_by_slice($slice,$author_obj,$odba);
};
$server->error_exit("Clones locked - exiting [$@]") if $@;

$server->log("Obtained the locks.");

if ($odba->isa('Bio::Vega::DBSQL::DBAdaptor')) {
    my $xml = Bio::Vega::Transform::XML->generate_OtterXML([$slice],$odba,0);
    $server->send_response($xml);
} elsif ($odba->isa('Bio::Otter::DBSQL::DBAdaptor')) {
    my $xml = Bio::Otter::Converter::path_to_XML($name, $start, $end,
                    $odba->assembly_type(), $slice->get_tiling_path() );
    $server->send_response($xml, 1);
} else {
    $server->error_exit("Require an Otter DB Adaptor and not '$odba'");
}

1;

